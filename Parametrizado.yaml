AWSTemplateFormatVersion: "2010-09-09"
Description: "Nightscout AWS EC2 - Vers?o Final. Amazon Linux 2023 - Docker + Nginx + Certbot + Dynu DynDNS"

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: Escolha a VPC onde a inst?ncia e o security group ser?o criados.
  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Escolha a Sub-rede P?BLICA (com acesso ? internet) onde a inst?ncia ser? criada.    
  DomainName:
    Type: String
    Description: Dominio Dynu completo exemplo miltonleao.ddnsfree.com
  DynuUser:
    Type: String
    Description: Usuario Dynu
  DynuPassword:
    Type: String
    NoEcho: true
    Description: Senha Dynu
  ApiSecret:
    Type: String
    NoEcho: true
    Description: API Secret do Nightscout
  MongoConnection:
    Type: String
    NoEcho: true
    Description: String completa de conexao MongoDB

Resources:
  NightscoutSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "SSH HTTP e HTTPS"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-SG"

  NightscoutInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.small
      #Alterar o nome da chave conforme criado em EC2 > SeguranÃ§a > Pares de chave
      KeyName: miltonleao
      ImageId: ami-07c0cae188e21a093 # Amazon Linux 2023 para sa-east-1
      NetworkInterfaces:
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet: 
            - !Ref NightscoutSecurityGroup
          SubnetId: !Ref SubnetId
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-Instance"
      UserData:
        Fn::Base64:
          Fn::Sub:
            - |
              #!/bin/bash -xe

              DOMAIN="${DomainName}"
              DYNU_USER="${DynuUser}"
              DYNU_PASS="${DynuPassword}"
              API_SECRET="${ApiSecret}"
              MONGO_CONNECTION="${MongoConnection}"

              dnf update -y
              dnf install -y docker curl nginx certbot python3-certbot-nginx bind-utils --allowerasing

              systemctl enable docker
              systemctl start docker

              docker run -d \
                --name nightscout \
                -p 1337:1337 \
                -e AUTH_DEFAULT_ROLES=denied \
                -e API_SECRET=$API_SECRET \
                -e MONGO_CONNECTION=$MONGO_CONNECTION \
                -e DISPLAY_UNITS=mg/dl \
                -e LANGUAGE=pt \
                nightscout/cgm-remote-monitor:latest

              cat > /etc/nginx/conf.d/nightscout.conf <<EOF
              server {
                  listen 80;
                  server_name $DOMAIN;

                  client_max_body_size 100M;

                  location / {
                      proxy_pass http://127.0.0.1:1337;
                      proxy_http_version 1.1;
                      proxy_set_header Host \$host;
                      proxy_set_header X-Real-IP \$remote_addr;
                      proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                      proxy_set_header X-Forwarded-Proto \$scheme;
                      proxy_set_header Upgrade \$http_upgrade;
                      proxy_set_header Connection "upgrade";
                      proxy_read_timeout 300;
                      proxy_connect_timeout 300;
                      proxy_send_timeout 300;
                  }
              }
              EOF

              systemctl enable nginx
              systemctl restart nginx

              cat > /usr/local/bin/update-dynu.sh <<EOF
              #!/bin/bash

              DOMAIN="$DOMAIN"
              USER="$DYNU_USER"
              PASS="$DYNU_PASS"

              MAX_RETRIES=10
              COUNT=0
              SUCCESS=false

              while [ \$COUNT -lt \$MAX_RETRIES ]; do

                  CURRENT_IP=\`curl -s https://checkip.amazonaws.com\`

                  if [ -z "\$CURRENT_IP" ]; then
                      sleep 5
                      COUNT=\$((COUNT+1))
                      continue
                  fi

                  RESPONSE=\`curl -s "https://api.dynu.com/nic/update?hostname=\$DOMAIN&myip=\$CURRENT_IP" \
                    --user "\$USER:\$PASS"\`

                  if echo "\$RESPONSE" | grep -q good; then
                      SUCCESS=true
                      break
                  fi

                  if echo "\$RESPONSE" | grep -q nochg; then
                      SUCCESS=true
                      break
                  fi

                  sleep 20
                  COUNT=\$((COUNT+1))

              done

              if [ "\$SUCCESS" = false ]; then
                exit 1
              fi
              EOF

              chmod +x /usr/local/bin/update-dynu.sh
              /usr/local/bin/update-dynu.sh

              cat > /etc/systemd/system/update-dynu.service <<EOF
              [Unit]
              Description=Atualiza Dynu com IP publico
              After=network.target

              [Service]
              Type=oneshot
              ExecStart=/usr/local/bin/update-dynu.sh
              EOF

              cat > /etc/systemd/system/update-dynu.timer <<EOF
              [Unit]
              Description=Executa update Dynu a cada 5 minutos

              [Timer]
              OnBootSec=2min
              OnUnitActiveSec=5min
              Unit=update-dynu.service

              [Install]
              WantedBy=timers.target
              EOF

              systemctl daemon-reload
              systemctl enable update-dynu.timer
              systemctl start update-dynu.timer

              INSTANCE_IP=`curl -s https://checkip.amazonaws.com`

              for i in {1..30}; do
                  RESOLVED_IP=`dig +short $DOMAIN | tail -n1`
                  if [ "$RESOLVED_IP" == "$INSTANCE_IP" ]; then
                      break
                  fi
                  sleep 20
              done

              certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m admin@$DOMAIN || true

              systemctl enable certbot-renew.timer
              systemctl start certbot-renew.timer

            - {}
